<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time series change points • mcp</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Time series change points">
<meta property="og:description" content="mcp">
<meta property="og:image" content="https://github.com/lindeloev/mcp/raw/master/man/figures/logo.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@jonaslindeloev">
<meta name="twitter:site" content="@jonaslindeloev">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-1026978-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1026978-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    General usage
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/formulas.html">Formulas</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
    <li>
      <a href="../articles/comparison.html">Hypotheses and model comparison</a>
    </li>
    <li>
      <a href="../articles/varying.html">Random/varying effects</a>
    </li>
    <li>
      <a href="../articles/variance.html">Modeling variance</a>
    </li>
    <li>
      <a href="../articles/arma.html">Time series and autocorrelation</a>
    </li>
    <li>
      <a href="../articles/predict.html">Fits and predictions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    GLM
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/families.html">Supported families and link functions</a>
    </li>
    <li>
      <a href="../articles/poisson.html">Poisson</a>
    </li>
    <li>
      <a href="../articles/binomial.html">Binomial and Bernoulli</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/packages.html">Comparison to other packages</a>
    </li>
    <li>
      <a href="../articles/debug.html">Tips, tricks, and debugging</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://twitter.com/jonaslindeloev">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/lindeloev/mcp">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lindeloev/mcp/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Time series change points</h1>
                        <h4 class="author">Jonas Kristoffer Lindeløv</h4>
            
            <h4 class="date">2020-08-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/lindeloev/mcp/blob/master/vignettes/arma.Rmd"><code>vignettes/arma.Rmd</code></a></small>
      <div class="hidden name"><code>arma.Rmd</code></div>

    </div>

    
    
<!--
 * Compute fit and interpret it
 * Warnings
 * Make a demo dataset and add to README
-->
<p>Autocorrelation is common in time series. You can specify N-order autoregressive models using <code><a href="https://rdrr.io/r/stats/ar.html">ar(N)</a></code> in the segment formulas. The most common use case is probably just to add <code><a href="https://rdrr.io/r/stats/ar.html">ar(1)</a></code> to the first segment. This will be “carried over” to later segments if nothing is done to change it - just like all other intercepts in mcp. You can do regression on the autocorrelation parameters using <code><a href="https://rdrr.io/r/stats/ar.html">ar(N, formula)</a></code> and it behaves much like <a href="../articles/variance.html"><code>sigma</code> to model variance</a>.</p>
<div id="simple-example" class="section level1">
<h1 class="hasAnchor">
<a href="#simple-example" class="anchor"></a>Simple example</h1>
<p>Let’s try and model the simulated <code>ex_ar</code> dataset. Take at look at <a href="https://github.com/lindeloev/mcp/tree/master/data-raw/ex_ar.R">how it was simulated with <code>mcp</code></a> and scroll down to see another simulation.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mcp</span>)
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">mc.cores</span> <span class="kw">=</span> <span class="fl">3</span>)  <span class="co"># Speed up sampling!</span></pre></body></html></div>
<p>We model this as a plateau (<code>1</code>) with a second-order autoregressive residual (<code><a href="https://rdrr.io/r/stats/ar.html">ar(2)</a></code>) followed by a joined slope (<code>0 + time</code>) with a negative first-order autoregressive residual (<code><a href="https://rdrr.io/r/stats/ar.html">ar(1)</a></code>):</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="no">price</span> ~ <span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">2</span>),  <span class="co"># int_1, ar1_1, ar2_1</span>
  ~ <span class="fl">0</span> + <span class="no">time</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">1</span>)  <span class="co"># time_2, ar1_2</span>
)
<span class="no">fit</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="no">ex_ar</span>)</pre></body></html></div>
<p>Let’s plot it and we see that AR was strong in the first segment and weaker-but-negative in the second:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="../reference/plot.mcpfit.html">plot</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<p><img src="arma_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>We can summarise the inferred coefficients:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../reference/summary.mcpfit.html">summary</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>## Family: gaussian(link = 'identity')
## Iterations: 9000 from 3 chains.
## Segments:
##   1: price ~ 1 + ar(2)
##   2: price ~ 1 ~ 0 + time + ar(1)
## 
## Population-level parameters:
##     name match   sim   mean   lower  upper Rhat n.eff
##    ar1_1    OK   0.7   0.74   0.587   0.89    1   907
##    ar1_2    OK  -0.4  -0.47  -0.685  -0.25    1  2316
##    ar2_1    OK   0.2   0.15   0.007   0.29    1   936
##     cp_1       120.0 117.24 114.044 118.84    1   339
##    int_1        20.0  17.51  15.050  19.59    1   382
##  sigma_1    OK   5.0   4.83   4.380   5.35    1  4869
##   time_2    OK   0.5   0.52   0.482   0.55    1   773</code></pre>
<p>Note that he naming syntax for autoregressive intercepts is <code>ar[order]_[segment]</code>. For example, <code>ar1_2</code> is the first-order autoregressive coefficient in segment 2. For slopes it will be <code>ar[order]_[normal mcp name]</code>, e.g., <code>ar1_x_3</code> for a slope on AR(1) in segment 3.</p>
<p>Comparing the columns <code>mean</code> and <code>sim</code> we see that the AR coefficients are reasonably recovered. In fact, the posterior mean is almost always exactly the same as <code><a href="https://rdrr.io/r/stats/arima.html">arima(data, order = c(N, 0, 0))</a></code> (see below), so the non-perfect fits are due to randomness in the simulation - not in the fit.</p>
<p>Notice that <code>sigma</code> in AR models describe <em>innovations</em>, i.e., the part of the residuals that are not explained by the autoregressive coefficients. <code><a href="https://rdrr.io/r/stats/sd.html">sd(ex_ar$price)</a></code> is always higher. In this case, the SD of raw data in the plateau is 9.2. As always, it is good to assess posteriors and convergence more directly:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_pars.html">plot_pars</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<p><img src="arma_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>Sometimes, the trace plot shows that the change point (<code>cp_1</code>) is not well identified with this model and data. As discussed in the article on <a href="../articles/tips.html">tips, tricks, and debugging</a>, you could combine a more informative prior with more samples (<code><a href="../reference/mcp.html">mcp(..., adapt = 10000, iter = 10000)</a></code>), if this is a problem.</p>
<p>You can do hypothesis testing (see <code><a href="../reference/hypothesis.html">hypothesis()</a></code>) and model comparisons (see <code><a href="../reference/criterion.html">loo()</a></code>) with autoregressive models, just as with any other model in <code>mcp</code>. <a href="../articles/comparison.html">Read more here</a> or scroll down for an applied example.</p>
</div>
<div id="tips-comments-and-warnings" class="section level1">
<h1 class="hasAnchor">
<a href="#tips-comments-and-warnings" class="anchor"></a>Tips, comments, and warnings</h1>
<p>The autoregressive modeling applies to the <em>residuals</em> from the predicted fit as is common. These residuals are computed on a transformed scale for families with a non-identity link function (e.g., <code><a href="https://rdrr.io/r/stats/family.html">poisson(link = "log")</a></code>). In time-series jargon, this is a <em>dynamical</em> regression model where the the “normal” regression parameters make up the <em>deterministic</em> structure. See further comments in the section on priors below.</p>
<p>If you want to control the <em>direction</em> of the change, you simply put a positive-only prior the corresponding ar slope coefficient, e.g., <code>ar_x_1 = "dnorm(0, 1) T(0, )</code>. See recommendations in <a href="#ar_prior">the section on priors for AR(N)</a>.</p>
<div id="regression-on-ar-coefficients" class="section level2">
<h2 class="hasAnchor">
<a href="#regression-on-ar-coefficients" class="anchor"></a>Regression on AR-coefficients</h2>
<p>While the typical usage is <code>AR(N)</code>, you can also specify how autocorrelation <em>itself</em> changes with <span class="math inline">\(x\)</span> using <code><a href="https://rdrr.io/r/stats/ar.html">ar(N, formula)</a></code>. If you want to model a steady change in the AR(1) “strength”, you can do <code><a href="https://rdrr.io/r/stats/ar.html">ar(1, 1 + time)</a></code>. Please note that the link function for this regression formula is identity, so you can easily exceed the stationary boundary [-1, 1]. See <a href="#ar_prior">the section on priors for AR(N)</a> how to counter such problems. The regression on the AR coefficients is applied to all orders. Raise an issue on GitHub if you see a use case for per-order control.</p>
<p>You have the full suite of <a href="../articles/formulas.html"><code>mcp</code> formula syntax</a> available inside <code>ar</code> so you could easily do <code><a href="https://rdrr.io/r/stats/ar.html">ar(3, rel(1) + I(x^2) + exp(x))</a></code>. Make sure to use a positive-only prior (e.g., <code>"dunif(0, 1)"</code> if using <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code> and <code><a href="https://rdrr.io/r/base/MathFun.html">sqrt()</a></code> since they fail for negative values.</p>
</div>
<div id="combining-ar-and-sigma" class="section level2">
<h2 class="hasAnchor">
<a href="#combining-ar-and-sigma" class="anchor"></a>Combining ar() and sigma()</h2>
<p>You can combine <code><a href="https://rdrr.io/r/stats/ar.html">ar()</a></code> with any regression model and with <a href="../articles/varying.html">varying change points</a>. Combining with <code><a href="https://rdrr.io/r/stats/sigma.html">sigma()</a></code> will run will be valid if they change intercepts together so that each segment has homoskedastic residuals, i.e.,</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="no">y</span> ~ <span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">1</span>) + <span class="fu"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="fl">1</span>),
  ~ <span class="fl">0</span> + <span class="no">x</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">1</span>) + <span class="fu"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="fl">1</span>),
  ~ <span class="fl">1</span>
)</pre></body></html></div>
<p>I have not tested whether “uncoordinated” changes will yield correct estimates as well, i.e., with slopes on <code><a href="https://rdrr.io/r/stats/sigma.html">sigma()</a></code>/<code><a href="https://rdrr.io/r/stats/ar.html">ar()</a></code> or for changes in <code><a href="https://rdrr.io/r/stats/sigma.html">sigma()</a></code> without a corresponding change in <code><a href="https://rdrr.io/r/stats/ar.html">ar()</a></code>. There is a good chance that they <em>will</em> be accurate because <code><a href="https://rdrr.io/r/stats/ar.html">ar()</a></code>/<code><a href="https://rdrr.io/r/stats/sigma.html">sigma()</a></code> are conditional on each other and they are modeled jointly for each <code>x</code>. But this is just a hunch that needs scrutinizing.</p>
</div>
<div id="order-your-data" class="section level2">
<h2 class="hasAnchor">
<a href="#order-your-data" class="anchor"></a>Order your data</h2>
<p>Note that AR(N) as implemented in <code>mcp</code> (and most functions in R) applies to the <em>order</em> of the data <em>in the data frame</em> without taking into account the actual value of <code>x</code>. This has two important implications:</p>
<ul>
<li>You probably want to sort your data according to your <code>x</code>. Just do <code>data = data[order(data$x), ]</code>.</li>
<li>Adjacent data points that lie years apart are modeled to be just as (auto)correlated as adjacent points lying seconds apart.</li>
</ul>
</div>
</div>
<div id="simulating-autocorrelated-change-point-data" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-autocorrelated-change-point-data" class="anchor"></a>Simulating autocorrelated change point data</h1>
<p>Assessing the correctness of autocorrelation is less intuitive than seeing e.g. a mean fit. However, we can verify <code>mcp</code> up against more tested-and-tried functions such as <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code> in base R. Let us simulate a single AR(3) segment, i.e., without change points, and see if it fits:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># Model</span>
<span class="no">model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">response</span> ~ <span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">3</span>))

<span class="co"># Simulate data</span>
<span class="no">empty</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="kw">sample</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">par_x</span> <span class="kw">=</span> <span class="st">"time"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">42</span>)  <span class="co"># For consistent "random" results</span>
<span class="no">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">time</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">200</span>)
<span class="no">df</span>$<span class="no">response</span> <span class="kw">=</span> <span class="no">empty</span>$<span class="fu"><a href="https://rdrr.io/r/stats/simulate.html">simulate</a></span>(
    <span class="no">df</span>$<span class="no">time</span>,
    <span class="kw">int_1</span> <span class="kw">=</span> <span class="fl">20</span>,
    <span class="kw">ar1_1</span> <span class="kw">=</span> <span class="fl">0.7</span>,
    <span class="kw">ar2_1</span> <span class="kw">=</span> <span class="fl">0.2</span>,
    <span class="kw">ar3_1</span> <span class="kw">=</span> -<span class="fl">0.4</span>,
    <span class="kw">sigma_1</span> <span class="kw">=</span> <span class="fl">8</span>)</pre></body></html></div>
<pre><code>## Generating residuals for AR(N) model since the response column/argument 'response' was not provided.</code></pre>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co"># Base arima AR(3)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/arima.html">arima</a></span>(<span class="no">df</span>$<span class="no">response</span>, <span class="kw">order</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">0</span>))</pre></body></html></div>
<pre><code>## 
## Call:
## arima(x = df$response, order = c(3, 0, 0))
## 
## Coefficients:
##          ar1     ar2      ar3  intercept
##       0.6977  0.2240  -0.4075    19.5554
## s.e.  0.0643  0.0799   0.0649     1.1297
## 
## sigma^2 estimated as 60.03:  log likelihood = -693.86,  aic = 1397.73</code></pre>
<p>OK, we can see that the <code>ar</code> coefficients and sigma (<span class="math inline">\(sigma = sqrt(sigma^2)\)</span>) is simulated correctly, if taking <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code> as ground truth. Inferring with <code>mcp</code> is straightforward:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="no">df</span>, <span class="kw">par_x</span> <span class="kw">=</span> <span class="st">"time"</span>)</pre></body></html></div>
<p>The Bayesian parameter estimates are in perfect correspondence with <code><a href="https://rdrr.io/r/stats/arima.html">arima()</a></code>, even where they deviate a tiny bit from the simulation parameters (due to the inherent randomness in simulating data):</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="../reference/summary.mcpfit.html">fixef</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>##      name match  sim       mean       lower      upper     Rhat n.eff
## 1   ar1_1    OK  0.7  0.6985114  0.57395916  0.8291144 1.000614  2298
## 2   ar2_1    OK  0.2  0.2272165  0.07080719  0.3808439 1.000161  1495
## 3   ar3_1    OK -0.4 -0.4060305 -0.53261954 -0.2726367 1.000733  2020
## 4   int_1    OK 20.0 19.6832375 17.32889505 21.9184507 1.002773  5804
## 5 sigma_1    OK  8.0  7.8872945  7.13786199  8.6726029 1.000573  5677</code></pre>
</div>
<div id="inferring-an-autocorrelation-only-change" class="section level1">
<h1 class="hasAnchor">
<a href="#inferring-an-autocorrelation-only-change" class="anchor"></a>Inferring an autocorrelation-only change</h1>
<p>One “side-effect” of the <code>mcp</code> implementation of autocorrelation using <code><a href="https://rdrr.io/r/stats/ar.html">ar()</a></code> <em>in the formulas</em> is that you can infer when autocorrelation parameters and structures change.</p>
<p>Let’s simulate a change point in autocorrelation and see if we can infer it later:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co"># The model</span>
<span class="no">model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="no">y</span> ~ <span class="fl">1</span> + <span class="no">x</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">1</span>),  <span class="co"># Slope</span>
  ~ <span class="fl">0</span> + <span class="no">x</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">1</span>)  <span class="co"># Slope and relative increase</span>
)

<span class="co"># Get predictions</span>
<span class="no">empty</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="kw">sample</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">42</span>)
<span class="no">df</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">100</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">200</span>))
<span class="no">df</span>$<span class="no">y</span> <span class="kw">=</span> <span class="no">empty</span>$<span class="fu"><a href="https://rdrr.io/r/stats/simulate.html">simulate</a></span>(
  <span class="no">df</span>$<span class="no">x</span>,
  <span class="kw">cp_1</span> <span class="kw">=</span> <span class="fl">60</span>,
  <span class="kw">int_1</span> <span class="kw">=</span> <span class="fl">20</span>,
  <span class="kw">x_1</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">x_2</span> <span class="kw">=</span> <span class="fl">1</span>,  <span class="co"># same slope</span>
  <span class="kw">ar1_1</span> <span class="kw">=</span> <span class="fl">0.8</span>, <span class="kw">ar1_2</span> <span class="kw">=</span> <span class="fl">0.2</span>,
  <span class="kw">sigma_1</span> <span class="kw">=</span> <span class="fl">5</span>)</pre></body></html></div>
<p>… and we use a prior to equate the slopes of each segment (read more about <a href="../articles/priors.html">using priors</a> to equate parameters and define constants). Now let’s see if we can recover these parameters. We use <code>sample = "both"</code> because we will do a Savage-Dickey test later.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">prior</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">x_2</span> <span class="kw">=</span> <span class="st">"x_1"</span>)  <span class="co"># Set the two slopes equal</span>
<span class="no">fit</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">df</span>, <span class="kw">prior</span> <span class="kw">=</span> <span class="no">prior</span>, <span class="kw">sample</span> <span class="kw">=</span> <span class="st">"both"</span>)</pre></body></html></div>
<p>First, let’s get a visual to see that the posterior is reasonably narrow and consistent:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="../reference/plot.mcpfit.html">plot</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<p><img src="arma_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>You could use <code><a href="../reference/plot.mcpfit.html">plot(fit, geom_data = "line")</a></code> for a more classical line plot of the time series data. You can omit plotting AR effect entirely setting <code><a href="../reference/plot.mcpfit.html">plot(fit, arma = FALSE)</a></code>. You can also plot the <code>ar1_</code> parameters directly using <code>which_y</code>, so the y-axis is the value of <code>ar1</code>:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="../reference/plot.mcpfit.html">plot</a></span>(<span class="no">fit</span>, <span class="kw">which_y</span> <span class="kw">=</span> <span class="st">"ar1"</span>, <span class="kw">lines</span> <span class="kw">=</span> <span class="fl">100</span>)</pre></body></html></div>
<p><img src="arma_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>We recovered the parameters, including the change point:</p>
<pre><code>## Family: gaussian(link = 'identity')
## Iterations: 9000 from 3 chains.
## Segments:
##   1: y ~ 1 + x + ar(1)
##   2: y ~ 1 ~ 0 + x + ar(1)
## 
## Population-level parameters:
##     name match  sim  mean lower upper Rhat n.eff
##    ar1_1    OK  0.8  0.79  0.68  0.90    1  2193
##    ar1_2    OK  0.2  0.11 -0.21  0.41    1   990
##     cp_1    OK 60.0 62.61 51.07 74.10    1   299
##    int_1    OK 20.0 20.80 15.77 26.15    1   165
##  sigma_1    OK  5.0  4.89  4.38  5.36    1  3903
##      x_1    OK  1.0  0.99  0.92  1.05    1   172
##      x_2    OK  1.0  0.99  0.92  1.05    1   172</code></pre>
<p>We can also plot some of the parameters. As usual, we see that the change point is not well defined by any known distribution. The fact that the posterior mean is around 60 does not (necessarily) mean that there is a high credence in this value. Usually, I find that any bi- or N-modality on the posterior matches well with what you would guess from looking at the raw data. As they say: Bayesian inference is common sense applied to data.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_pars.html">plot_pars</a></span>(<span class="no">fit</span>, <span class="kw">regex_pars</span> <span class="kw">=</span> <span class="st">"cp_1|ar_*"</span>)</pre></body></html></div>
<p><img src="arma_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>As usual, we can test hypotheses and do model comparison (<a href="../articles/comparison.html">read more here</a>). We can also ask how much more likely it is (relative to the prior) that there the two autocorrelations are equal compared to them differing. Because we sampled both the prior and posterior (<code><a href="../reference/mcp.html">mcp(..., sample = "both")</a></code>), we can do a Savage-Dickey density ratio test:</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="../reference/hypothesis.html">hypothesis</a></span>(<span class="no">fit</span>, <span class="st">"ar1_1 = ar1_2"</span>)</pre></body></html></div>
<pre><code>##          hypothesis      mean     lower    upper            p           BF
## 1 ar1_1 - ar1_2 = 0 0.6869875 0.3799884 1.007476 0.0001565573 0.0001565818</code></pre>
<p>In this case, the evidence for equality is so small that it is rounded to zero. This means that not even a single MCMC sample visited a state with noticeable density at zero difference.</p>
<p>We can assess the same hypothesis using cross-validation, only this time it is more about whether the change point increases the predictive accuracy. The change point is favored with an <code>elpd_diff/se_diff</code> factor of around 2.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">fit_null</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">y</span> ~ <span class="fl">1</span> + <span class="no">x</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">1</span>)), <span class="kw">data</span> <span class="kw">=</span> <span class="no">df</span>)
<span class="no">fit</span>$<span class="no">loo</span> <span class="kw">=</span> <span class="fu"><a href="../reference/criterion.html">loo</a></span>(<span class="no">fit</span>)
<span class="no">fit_null</span>$<span class="no">loo</span> <span class="kw">=</span> <span class="fu"><a href="../reference/criterion.html">loo</a></span>(<span class="no">fit_null</span>)

<span class="kw pkg">loo</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html">loo_compare</a></span>(<span class="no">fit</span>$<span class="no">loo</span>, <span class="no">fit_null</span>$<span class="no">loo</span>)</pre></body></html></div>
<pre><code>##        elpd_diff se_diff
## model1  0.0       0.0   
## model2 -8.8       4.3</code></pre>
<p>Of course, we can also do directional tests. For example, what is the evidence that <code>ar1_1</code> is more than 0.3 greater than <code>ar1_2</code>? Answer: around 100 to one.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="../reference/hypothesis.html">hypothesis</a></span>(<span class="no">fit</span>, <span class="st">"ar1_1 - 0.3 &gt; ar1_2"</span>)</pre></body></html></div>
<pre><code>##                hypothesis      mean      lower     upper         p       BF
## 1 ar1_1 - 0.3 - ar1_2 &gt; 0 0.3869875 0.07998841 0.7074764 0.9907778 107.4337</code></pre>
</div>
<div id="ar_prior" class="section level1">
<h1 class="hasAnchor">
<a href="#ar_prior" class="anchor"></a>Priors on autoregressive coefficients</h1>
<p>The default prior on autoregressive intercepts is a <code><a href="https://rdrr.io/r/stats/Uniform.html">dunif(-1, 1)</a></code> to ensure a stationary series while being otherwise agnostic about the magnitude and direction of the autocorrelation. For most time series, you would expect a positive first-order autocorrelation, e.g., <code>ar1_1 = "dunif(0, 1)"</code> or even something like <code>ar1_1 = "dnorm(0.5, 0.5) T(0, 1)"</code>. <a href="../articles/priors.html">Read more about priors</a>. Similarly, you would expect a smaller-but-still-positive second-order autocorrelation, e.g., <code>ar2_1 = dunif(0, ar1_1)</code>.</p>
<p>Here is a complete list of the (default) priors in the model above:</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">fit</span>$<span class="no">prior</span>)</pre></body></html></div>
<pre><code>##         [,1]                           
## cp_1    "dunif(MINX, MAXX)"            
## int_1   "dt(0, 3 * SDY, 3)"            
## x_1     "dt(0, SDY / (MAXX - MINX), 3)"
## x_2     "x_1"                          
## sigma_1 "dnorm(0, SDY) T(0, )"         
## ar1_1   "dunif(-1, 1)"                 
## ar1_2   "dunif(-1, 1)"</code></pre>
<p>We can also visualize them because we sampled the prior. <code>prior = TRUE</code> works in most <code>mcp</code> functions, including <code><a href="../reference/plot.mcpfit.html">plot()</a></code> and <code><a href="../reference/summary.mcpfit.html">summary()</a></code>.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_pars.html">plot_pars</a></span>(<span class="no">fit</span>, <span class="kw">prior</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p><img src="arma_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
<p>Notice that the posteriors are smoothed at sharp cutoffs, slightly misrepresenting the true distribution.</p>
<p>Let’s inspect the priors for a more advanced AR model, since you would often have to inform these:</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="no">model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="no">y</span> ~ <span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">2</span>, <span class="fl">1</span> + <span class="no">x</span>),
  ~ <span class="fl">0</span> + <span class="fu"><a href="https://rdrr.io/r/stats/ar.html">ar</a></span>(<span class="fl">1</span>, <span class="fu">rel</span>(<span class="fl">1</span>) + <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span>(<span class="no">x</span>^<span class="fl">2</span>))
)
<span class="no">empty</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="kw">sample</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">empty</span>$<span class="no">prior</span>)</pre></body></html></div>
<pre><code>##            [,1]                         
## cp_1       "dunif(MINX, MAXX)"          
## int_1      "dt(0, 3 * SDY, 3)"          
## sigma_1    "dnorm(0, SDY) T(0, )"       
## ar1_1      "dunif(-1, 1)"               
## ar2_1      "dunif(-1, 1)"               
## ar1_x_1    "dnorm(0, 1 / (MAXX - MINX))"
## ar2_x_1    "dnorm(0, 1 / (MAXX - MINX))"
## ar1_2      "dunif(-1, 1)"               
## ar1_x_2_E2 "dnorm(0, 1 / (MAXX - MINX))"</code></pre>
<p>As with <code>sigma</code>, the link function for the autoregressive coefficient itself is <code>"identity"</code> though the autoregressive coefficient is computed from residuals using the link function provided in <code><a href="../reference/mcp.html">mcp(..., family = func(link = "something"))</a></code>. Because stationarity is important, careful consideration of the allowed and probable values (the prior) is necessary when going beyond simple absolute intercepts to avoid <code>ar</code> values outside [-1, 1].</p>
<p>Here are a few ways in which you may want to inform the <code>ar</code> parameters in the model above:</p>
<ul>
<li>As mentioned above, you may want to constrain second-order autocorrelations to <code>ar2_1 ~ dunif(0, ar1_1)</code>.</li>
<li>The relative change in intercept in the second segment (<code>ar1_2</code>) can at most be -1 with the default prior. If <code>ar1_1</code> was 0.8, this means that it can at most change to -0.2 in the next segment. Use <code>rel()</code> with care.</li>
<li>Slopes can quickly make the parameter exceed the -1 and 1 boundaries, inducing non-stationarity. You would often want to constrain their magnitude to small slopes, taking into consideration the expected span of the x-axis over which this slope runs. The default prior on <code>ar</code>-slopes is a 68% change that there is a change of 1 from the first to the last observation (<code>"dnorm(0, 1 / (MAXX - MINX))"</code>) and you may want to, for example, suggest a shallow negative slope using <code>"dnorm(0, 0.1 / (MAXX-MINX)) T( , 0)"</code>
</li>
</ul>
</div>
<div id="jags-code" class="section level1">
<h1 class="hasAnchor">
<a href="#jags-code" class="anchor"></a>JAGS code</h1>
<p>Here is the JAGS code for the second simulation example, i.e., the one with a single slope going from AR(2) to AR(1). You can print <code>fit$simulate</code> and see that it runs much of the same code.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">fit</span>$<span class="no">jags_code</span>)</pre></body></html></div>
<pre><code>## 
## model {
## 
##   # Priors for population-level effects
##   cp_0 = MINX  # mcp helper value.
##   cp_2 = MAXX  # mcp helper value.
## 
##   cp_1 ~ dunif(MINX, MAXX)
##   int_1 ~ dt(0, 1/(3*SDY)^2, 3) 
##   x_1 ~ dt(0, 1/(SDY/(MAXX-MINX))^2, 3) 
##   x_2 = x_1  # Fixed
##   sigma_1 ~ dnorm(0, 1/(SDY)^2) T(0, )
##   ar1_1 ~ dunif(-1, 1)
##   ar1_2 ~ dunif(-1, 1)
## 
## 
##   # Apply autoregression to the residuals
##   resid_arma_[1] = 0
##   for (i_ in 2:length(x)) {
##     resid_arma_[i_] = 0 + 
##       ar1_[i_] * resid_abs_[i_ - 1]
##   }
## 
##   # Model and likelihood
##   for (i_ in 1:length(x)) {
##     X_1_[i_] = min(x[i_], cp_1)
##     X_2_[i_] = min(x[i_], cp_2) - cp_1
##     
##     # Fitted value
##     y_[i_] = 
##     
##       # Segment 1: y ~ 1 + x + ar(1)
##       (x[i_] &gt;= cp_0) * int_1 + 
##       (x[i_] &gt;= cp_0) * x_1 * X_1_[i_] + 
##     
##       # Segment 2: y ~ 1 ~ 0 + x + ar(1)
##       (x[i_] &gt;= cp_1) * x_2 * X_2_[i_] 
##     
##     # Fitted standard deviation
##     sigma_[i_] = max(0, 
##       (x[i_] &gt;= cp_0) * sigma_1 )
##     
##     # Autoregressive coefficient for all AR(1)
##     ar1_[i_] = 
##       (x[i_] &gt;= cp_0) * (x[i_] &lt; cp_1) * ar1_1 + 
##       (x[i_] &gt;= cp_1) * ar1_2 
## 
##     # Likelihood and log-density for family = gaussian()
##     y[i_] ~ dnorm((y_[i_] + resid_arma_[i_]), 1 / sigma_[i_]^2)  # SD as precision
##     loglik_[i_] = logdensity.norm(y[i_], (y_[i_] + resid_arma_[i_]), 1 / sigma_[i_]^2)  # SD as precision
##     resid_abs_[i_] = (y[i_])  - y_[i_]  # Residuals represented by sigma_ after ARMA
##   }
## }</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://lindeloev.net">Jonas Kristoffer Lindeløv</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '702ab134d40a7310606c29f341fc5014',
    indexName: 'lindeloev_mcp',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
