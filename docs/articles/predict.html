<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fits and predictions • mcp</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Fits and predictions">
<meta property="og:description" content="mcp">
<meta property="og:image" content="https://github.com/lindeloev/mcp/raw/master/man/figures/logo.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@jonaslindeloev">
<meta name="twitter:site" content="@jonaslindeloev">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-1026978-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-1026978-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mcp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    General usage
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/formulas.html">Formulas</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
    <li>
      <a href="../articles/comparison.html">Hypotheses and model comparison</a>
    </li>
    <li>
      <a href="../articles/varying.html">Random/varying effects</a>
    </li>
    <li>
      <a href="../articles/variance.html">Modeling variance</a>
    </li>
    <li>
      <a href="../articles/arma.html">Time series and autocorrelation</a>
    </li>
    <li>
      <a href="../articles/predict.html">Fits and predictions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    GLM
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/families.html">Supported families and link functions</a>
    </li>
    <li>
      <a href="../articles/poisson.html">Poisson</a>
    </li>
    <li>
      <a href="../articles/binomial.html">Binomial and Bernoulli</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/packages.html">Comparison to other packages</a>
    </li>
    <li>
      <a href="../articles/debug.html">Tips, tricks, and debugging</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://twitter.com/jonaslindeloev">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/lindeloev/mcp">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lindeloev/mcp/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fits and predictions</h1>
                        <h4 class="author">Jonas Kristoffer Lindeløv</h4>
            
            <h4 class="date">2020-08-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/lindeloev/mcp/blob/master/vignettes/predict.Rmd"><code>vignettes/predict.Rmd</code></a></small>
      <div class="hidden name"><code>predict.Rmd</code></div>

    </div>

    
    
<p>This article introduces <code><a href="../reference/predict.mcpfit.html">predict()</a></code>, <code><a href="../reference/fitted.mcpfit.html">fitted()</a></code>, <code><a href="../reference/residuals.mcpfit.html">residuals()</a></code> for in-sample and out-of-sample data. I will also show how to get creative with <code>mcp</code>, including how to make predictions around future change points.</p>
<div id="preparation-an-example-model" class="section level1">
<h1 class="hasAnchor">
<a href="#preparation-an-example-model" class="anchor"></a>Preparation: an example model</h1>
<p>We need an <code>mcpfit</code> to get started. We take the <code>ex_demo</code> dataset:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mcp</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">ex_demo</span>)</pre></body></html></div>
<pre><code>##       time  response
## 1 68.35820 32.842651
## 2 87.29038 -1.160003
## 3 69.01173 27.564248
## 4 11.59361 10.062971
## 5 19.50091 14.056859
## 6 46.12009 18.292640</code></pre>
<p>… and model it as three segments, i.e., two change points:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># Define the model</span>
<span class="no">model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="no">response</span> ~ <span class="fl">1</span>,  <span class="co"># plateau (int_1)</span>
  ~ <span class="fl">0</span> + <span class="no">time</span>,    <span class="co"># joined slope (time_2) at cp_1</span>
  ~ <span class="fl">1</span> + <span class="no">time</span>     <span class="co"># disjoined slope (int_3, time_3) at cp_2</span>
)

<span class="co"># Fit it. The `ex_demo` dataset is included in mcp</span>
<span class="no">fit</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">ex_demo</span>)</pre></body></html></div>
<p>This is what the data and the inferred fit looks like with 95% credible interval and a 80% prediction interval:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../reference/plot.mcpfit.html">plot</a></span>(<span class="no">fit</span>, <span class="kw">q_fit</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">q_predict</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>))</pre></body></html></div>
<p><img src="predict_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>To review what we see here:</p>
<ul>
<li>The black dots is the data from <code>ex_demo</code>.</li>
<li>The gray lines are 25 samples from the posterior (control using <code><a href="../reference/plot.mcpfit.html">plot(fit, lines = 100)</a></code>).</li>
<li>The dashed red lines are the 2.5% and 97.% quantiles of the fitted (expected) values.</li>
<li>The green lines are the 10% and 90% quantiles of the predicted values.</li>
<li>The blue curves on the x-axis are the posterior distributions of the change point locations (better viewed using <code><a href="../reference/plot_pars.html">plot_pars(fit, pars = c("cp_1", "cp_2"))</a></code>).</li>
</ul>
<p>Behind the scenes, <code><a href="../reference/plot.mcpfit.html">plot()</a></code> merely calls <code><a href="../reference/predict.mcpfit.html">predict()</a></code> and <code><a href="../reference/fitted.mcpfit.html">fitted()</a></code> to show these inferences.</p>
</div>
<div id="extracting-fitted-values" class="section level1">
<h1 class="hasAnchor">
<a href="#extracting-fitted-values" class="anchor"></a>Extracting <code>fitted()</code> values</h1>
<p>To get the fitted valus for each data point, simply do <code><a href="../reference/fitted.mcpfit.html">fitted(fit)</a></code>:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="../reference/fitted.mcpfit.html">fitted</a></span>(<span class="no">fit</span>))</pre></body></html></div>
<pre><code>##       time    fitted     error      Q2.5     Q97.5
## 1 68.35820 30.335398 1.0490838 28.302061 32.392469
## 2 87.29038 -3.331223 0.7600690 -4.806130 -1.815527
## 3 69.01173 30.685351 1.0824300 28.588563 32.799913
## 4 11.59361 10.256882 0.7356098  8.824521 11.671404
## 5 19.50091 10.264763 0.7229024  8.856258 11.671404
## 6 46.12009 18.427314 1.0305693 16.080953 20.113827</code></pre>
<p>In general, this output will include:</p>
<ul>
<li><p>A column for each predictor column in the data. Here, <code>time</code> is the only predictor and you see the values in the same order as in <code>ex_demo</code> (which is copied to <code>fit$data</code>). But models with <a href="../articles/varying.html">varying change points</a> will additionally have a column for the varying data, <code><a href="https://rdrr.io/r/stats/family.html">binomial()</a></code> models include the number of trials, etc.</p></li>
<li><p><strong>fitted:</strong> The fitted value which is the mean of the posterior for this predictor value (or set of predictor values). I.e., it is the <em>Expected Value (EV)</em>.</p></li>
<li><p><strong>error:</strong>: The standard error corresponding to <code>fitted</code>, i.e., <code><a href="https://rdrr.io/r/base/diff.html">diff(fitted + c(-1, 1) * error)</a></code> is the 68% credible interval.</p></li>
<li><p><strong>Q[some number]:</strong> The quantiles of the fitted distribution. You can set the quantiles using <code><a href="../reference/fitted.mcpfit.html">fitted(fit, probs = c(0.1, 0.5, 0.9))</a></code>.</p></li>
</ul>
<p>If you compare these values to the plot, you will see that they correspond. <code><a href="../reference/plot.mcpfit.html">plot()</a></code> merely calls <code><a href="../reference/fitted.mcpfit.html">fitted()</a></code> behind the scenes.</p>
<div id="expected-values-for-out-of-sample-data" class="section level2">
<h2 class="hasAnchor">
<a href="#expected-values-for-out-of-sample-data" class="anchor"></a>Expected values for out-of-sample data</h2>
<p>To predict out-of-sample data, you can simply use the <code>newdata</code> argument.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">newdata</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">time</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ex_demo</span>$<span class="no">time</span>[<span class="fl">1</span>], <span class="fl">25</span>, -<span class="fl">20</span>, <span class="fl">200</span>))
<span class="fu"><a href="../reference/fitted.mcpfit.html">fitted</a></span>(<span class="no">fit</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">newdata</span>)</pre></body></html></div>
<pre><code>##       time    fitted      error       Q2.5     Q97.5
## 1  68.3582  30.33540  1.0490838  28.302061 32.392469
## 2  25.0000  10.32299  0.7159178   8.968497 11.757525
## 3 -20.0000  10.25686  0.7357178   8.824521 11.671404
## 4 200.0000 -28.41087 10.5279362 -49.894271 -8.857697</code></pre>
<p>Note that:</p>
<ul>
<li>We get one row per value of <code>time</code>.</li>
<li>The first value for <code>time</code> is in the dataset. The values correspond to the same row in <code><a href="../reference/fitted.mcpfit.html">fitted(fit)</a></code> bacause that’s merely a shortcut to do <code><a href="../reference/fitted.mcpfit.html">fitted(fit, newdata = fit$data)</a></code>.</li>
<li>The second value (<code>time = 20</code>) is within the observed region, but not in the dataset.</li>
<li>The third value (<code>time = - 20</code>) is outside the observed region, but <code>mcp</code> merely extends the first segment backwards in time. Because it’s a plateau, we see approximately the same values as for <code>time = 20</code>.</li>
<li>The fourth value (<code>time = 200</code>) is way outside the observed region. Because it is the extrapolation of the slope in the third segment of which we’ve only observed the first tiny bit, the posterior distribution is very wide because even a small uncertainty in the slope results in very large differences further out.</li>
</ul>
</div>
<div id="arguments" class="section level2">
<h2 class="hasAnchor">
<a href="#arguments" class="anchor"></a>Arguments</h2>
<p>If you look at the documentation for <code><a href="../reference/predict.mcpfit.html">predict()</a></code>, <code><a href="../reference/fitted.mcpfit.html">fitted()</a></code>, and <code><a href="../reference/residuals.mcpfit.html">residuals()</a></code>, you’ll see that they are quite versatile, taking many different arguments. To mention a few, you can set <code>which_y = "sigma"</code> to get fitted values for <code>sigma</code> <a href="../articles/variance.html">more on modeling sigma</a>, <code>prior = TRUE</code> to predict using only the prior, <code>varying = TRUE</code> and <code>arma = FALSE</code> can be toggled to include/exclude AR(N) and varying effects.</p>
</div>
</div>
<div id="predictions" class="section level1">
<h1 class="hasAnchor">
<a href="#predictions" class="anchor"></a>Predictions</h1>
<p><code><a href="../reference/predict.mcpfit.html">predict()</a></code> is the posterior predictive and it takes exactly the same arguments as <code><a href="../reference/fitted.mcpfit.html">fitted()</a></code>. This means that you can make predictions for in-sample and out-of-sample data as well. As with <code><a href="../reference/fitted.mcpfit.html">fitted()</a></code>, <code><a href="../reference/plot.mcpfit.html">plot()</a></code> uses <code><a href="../reference/predict.mcpfit.html">predict()</a></code> under the hood to plot prediction intervals. You can see that the values correspond to dashed green lines in the plot (the 80% prediction interval):</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">42</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="../reference/predict.mcpfit.html">predict</a></span>(<span class="no">fit</span>, <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>)))</pre></body></html></div>
<pre><code>##       time   predict    error       Q10       Q90
## 1 68.35820 30.258067 4.179138 24.973645 35.505338
## 2 87.29038 -3.360078 4.111718 -8.590586  1.915983
## 3 69.01173 30.736211 4.141409 25.435909 35.968476
## 4 11.59361 10.222312 4.082259  5.022415 15.387142
## 5 19.50091 10.148523 4.087641  4.934426 15.379917
## 6 46.12009 18.438419 4.115260 13.211549 23.734503</code></pre>
<p>Note that <code><a href="../reference/predict.mcpfit.html">predict()</a></code> uses random sampling under the hood, so these values will differ slightly from call to call. You can make it replicable using <code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code> as above. In general, the more posterior samples, the less the call-to-call variance will be. Conversely, fewer samples means more call-to-call variation, e.g., if you do <code><a href="../reference/predict.mcpfit.html">predict(fit, nsamples = 10)</a></code>).</p>
</div>
<div id="residuals" class="section level1">
<h1 class="hasAnchor">
<a href="#residuals" class="anchor"></a>Residuals</h1>
<p><code><a href="../reference/residuals.mcpfit.html">residuals()</a></code> is simply <code>data$response - fitted()</code>. It may be useful for model checking, but the typical needs are covered using posterior predictive checking (<code><a href="../reference/pp_check.html">pp_check(fit)</a></code>) and visual inspection of <code><a href="../reference/plot.mcpfit.html">plot(fit, q_fit = TRUE, q_predict = TRUE)</a></code>.</p>
</div>
<div id="forecasting-with-future-change-points" class="section level1">
<h1 class="hasAnchor">
<a href="#forecasting-with-future-change-points" class="anchor"></a>Forecasting with future change points</h1>
<p>Bayesian inference is the principled updating of prior knowledge using data. Where there is little or now data, the prior speaks louder. Sometimes, we can learn surprising stuff simply by inspecting the prior predictive, e.g., how the priors combine when “put through” the model. In <code>mcp</code>, most functions come with a <code>prior = FALSE</code> default, but you can simply do <code><a href="../reference/plot.mcpfit.html">plot(fit, prior = TRUE)</a></code>, <code><a href="../reference/fitted.mcpfit.html">fitted(fit, prior = TRUE)</a></code>, or <code><a href="../reference/predict.mcpfit.html">predict(fit, prior = TRUE)</a></code>.</p>
<p>Say you want to forecast at <code>time = 125</code> and you know that a changepoint to the baseline level (an intercept change to <code>int_1</code>) will occur approximately after the same interval as between <code>cp_1</code> and <code>cp_2</code> (i.e., at <code>cp_2 + (cp_2 - cp_1)</code>. Here is a way to “hack” <code>mcp</code> to do this. <em>(NOTE: I plan on implementing this in a much more user-friendly way in a future release; see the discussion in <a href="https://github.com/lindeloev/mcp/issues/78">this github issue</a> and current status in <a href="https://github.com/lindeloev/mcp/issues/82">this github issue</a>)</em>.</p>
<div id="step-1-run-the-model-for-observed-data" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1-run-the-model-for-observed-data" class="anchor"></a>Step 1: run the model for observed data</h2>
<p>We already did that above, resulting in our <code>fit</code>. But we only do it to get the default priors that are suitable for inferring change point in this region, so you could’ve just run it without sampling:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">ex_demo</span>, <span class="kw">sample</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
</div>
<div id="step-2-fit-a-model-including-the-unobserved-regions" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2-fit-a-model-including-the-unobserved-regions" class="anchor"></a>Step 2: fit a model including the unobserved regions</h2>
<p>Now we extend the model with the future segment of which we have prior knowledge:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">model_forecast</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="no">response</span> ~ <span class="fl">1</span>,  <span class="co"># plateau (int_1)</span>
  ~ <span class="fl">0</span> + <span class="no">time</span>,    <span class="co"># joined slope (time_2) at cp_1</span>
  ~ <span class="fl">1</span> + <span class="no">time</span>,    <span class="co"># disjoined slope (int_3, time_3) at cp_2</span>
  ~ <span class="fl">1</span>     <span class="co"># joined slope (time_4) at cp_3</span>
)</pre></body></html></div>
<p>And finally, we extend the list of priors with the two new parameters (<code>time_4</code> and <code>cp_3</code>). It may be helpful to review <a href="../articles/priors.html">the article on priors in mcp</a>.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">prior_forecast</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">fit</span>$<span class="no">prior</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="kw">int_4</span> <span class="kw">=</span> <span class="st">"int_1"</span>,  <span class="co"># Return to this value</span>
  <span class="kw">cp_3</span> <span class="kw">=</span> <span class="st">"dnorm(cp_2 + (cp_2 - cp_1), 20) T(MAXX, )"</span>  <span class="co"># In the future at the same interval</span>
))</pre></body></html></div>
<p>Now let’s fit it:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">fit_forecast</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mcp.html">mcp</a></span>(<span class="no">model_forecast</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">ex_demo</span>, <span class="kw">prior</span> <span class="kw">=</span> <span class="no">prior_forecast</span>)</pre></body></html></div>
</div>
<div id="step-3-predict" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3-predict" class="anchor"></a>Step 3: predict!</h2>
<p>We can go right ahead and compute our 50% and 80% prediction intervals at <code>time = 125</code>:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="../reference/predict.mcpfit.html">predict</a></span>(<span class="no">fit_forecast</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">time</span> <span class="kw">=</span> <span class="fl">125</span>), <span class="kw">probs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span>))</pre></body></html></div>
<pre><code>##   time  predict    error       Q10       Q25      Q75     Q90
## 1  125 3.700895 11.05037 -13.93596 -6.340951 11.74761 14.6364</code></pre>
<p>To really understand what’s going on here, it may be helpful to visualize the model. For now, we will have to hack this a bit too, manually doing our plot:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="co"># Get posterior and posterior predictive "predictions"</span>
<span class="no">newdata</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">time</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">170</span>)
<span class="no">fitted_forecast</span> <span class="kw">=</span> <span class="fu"><a href="../reference/fitted.mcpfit.html">fitted</a></span>(<span class="no">fit_forecast</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">newdata</span>, <span class="kw">summary</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">nsamples</span> <span class="kw">=</span> <span class="fl">50</span>)
<span class="no">predict_forecast</span> <span class="kw">=</span> <span class="fu"><a href="../reference/predict.mcpfit.html">predict</a></span>(<span class="no">fit_forecast</span>, <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">newdata</span>, <span class="kw">summary</span> <span class="kw">=</span> <span class="fl">FALSE</span>)

<span class="co"># Plot it</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">predict_forecast</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">predict</span>)) +
  <span class="co"># Prediction intervals and line at x = 125</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span>(<span class="kw">fun.data</span> <span class="kw">=</span> <span class="no">median_hilow</span>, <span class="kw">fun.args</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">conf.int</span> <span class="kw">=</span> <span class="fl">0.8</span>), <span class="kw">geom</span> <span class="kw">=</span> <span class="st">"ribbon"</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span>(<span class="kw">fun.data</span> <span class="kw">=</span> <span class="no">median_hilow</span>, <span class="kw">fun.args</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">conf.int</span> <span class="kw">=</span> <span class="fl">0.5</span>), <span class="kw">geom</span> <span class="kw">=</span> <span class="st">"ribbon"</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.3</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="kw">xintercept</span> <span class="kw">=</span> <span class="fl">125</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">lwd</span> <span class="kw">=</span> <span class="fl">1</span>) +

  <span class="co"># Lines for fitted draws</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">fitted</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">.draw</span>), <span class="kw">data</span> <span class="kw">=</span> <span class="no">fitted_forecast</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.2</span>) +

  <span class="co"># Observed data</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">response</span>), <span class="kw">data</span> <span class="kw">=</span> <span class="no">ex_demo</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Predicting with future change points"</span>)</pre></body></html></div>
<p><img src="predict_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>You can read the predicted values from above at <code>x = 125</code> off this graph. We literally just predicted for all values between 1 and 170, and visualized it using a ribbon. This means that you can also predict further into the future, if you’d like.</p>
<p>You can extend this approach to an arbitrary number of future segments, even using the posterior from the “unobserved” segment 4 in the priors for parameters in future segments. In Bayesian inference, it really does not make much of a difference whether credence in some parameter values have been updated using data or not - it’s all credence.</p>
<p>Without doing this formal model of the future change point, one may have thought that the change point should occur around <code>time = 110</code> since that’s the expected value of <code>cp_2 + (cp_2 - cp_1)</code>. However, we truncated the prior for the future change point (<code>cp_3</code>) so that it occurs <em>after</em> the last data point (<code>MAXX</code>), i.e., at <code>time &gt; 100</code>. This is knowledge that the third change point had not yet been observed at <code>time = 100</code>, and this pushes the distribution further into the future (actually around 118; see <code><a href="../reference/summary.mcpfit.html">summary(fit_forecast)</a></code>).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://lindeloev.net">Jonas Kristoffer Lindeløv</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '702ab134d40a7310606c29f341fc5014',
    indexName: 'lindeloev_mcp',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
